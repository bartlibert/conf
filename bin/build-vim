#!/bin/bash

PREFIX=/usr/local
BUILDDIR="${PWD}/.build"
SRCDIR="${BUILDDIR}${PREFIX}"
echo "Building with: PREFIX=$PREFIX BUILDDIR=$BUILDDIR SRCDIR=$SRCDIR"

OPTS="--prefix=${PREFIX} --localstatedir=/var/lib/vim --mandir=${PREFIX}/share/man --with-features=big --disable-gpm --enable-acl --with-x=yes --enable-multibyte --enable-cscope --enable-perlinterp"
echo "Configure options: $OPTS"


mkdir -p $BUILDDIR                                                || exit 1

make distclean                                                    || exit 1
./configure $OPTS                                                 || exit 1
make                                                              || exit 1
make DESTDIR=$BUILDDIR install                                    || exit 1

pushd ${SRCDIR}/bin                                               || exit 1
    rm -f ex view                                                 || exit 1
    mv vim vim-normal                                             || exit 1
    ln -sf vim-normal vim                                         || exit 1
    ln -sf vim-normal rview                                       || exit 1
    ln -sf vim-normal rvim                                        || exit 1
    ln -sf vim-normal vimdiff                                     || exit 1
popd                                                              || exit 1

find ${SRCDIR}/share/man -type d -name 'man1' 2> /dev/null | \
    while read _mandir; do
        pushd ${_mandir}                                          || exit 1
            rm -f ex.1 view.1                                     || exit 1
            rm -f evim.1                                          || exit 1
        popd                                                      || exit 1
    done

sudo rsync -av ${SRCDIR}/ $PREFIX                                 || exit 1

rm -rf $BUILDDIR                                                  || exit 1
mkdir -p $BUILDDIR                                                || exit 1

make distclean                                                    || exit 1
./configure $OPTS --enable-gui=gtk2                               || exit 1
make                                                              || exit 1
make DESTDIR=$BUILDDIR install                                    || exit 1

pushd ${SRCDIR}/bin                                               || exit 1
    rm -f xxd ex view vimtutor vimdiff rview rvim                 || exit 1
    mv vim vim-big                                                || exit 1
    ln -sf vim-big eview                                          || exit 1
    ln -sf vim-big evim                                           || exit 1
    ln -sf vim-big gview                                          || exit 1
    ln -sf vim-big gvim                                           || exit 1
    ln -sf vim-big gvimdiff                                       || exit 1
    ln -sf vim-big rgview                                         || exit 1
    ln -sf vim-big rgvim                                          || exit 1
popd                                                              || exit 1

find ${SRCDIR}/share/man -type d -name 'man1' 2> /dev/null | \
    while read _mandir; do
        pushd ${_mandir}                                          || exit 1
            rm -f ex.1 view.1                                     || exit 1
            rm -f rvim.1 rview.1 vim.1 vimtutor.1 vimdiff.1 xxd.1 || exit 1
        popd                                                      || exit 1
    done

rm -rf ${SRCDIR}/share/vim                                        || exit 1

sudo rsync -av ${SRCDIR}/ $PREFIX                                 || exit 1

rm -rf $BUILDDIR                                                  || exit 1
